sap.ui.define(["com/eramet/Convergence_Achat_Magasin/controller/BaseController","com/eramet/Convergence_Achat_Magasin/util/constans","com/eramet/Convergence_Achat_Magasin/util/formatter","sap/m/MessageBox"],function(e,t,s,a){"use strict";return e.extend("com.eramet.Convergence_Achat_Magasin.controller.ListeServir.Liste",{aOldValues:[10,5,8],onInit:function(){this.getRouter().attachRoutePatternMatched(this._onRouteMatched,this)},_onRouteMatched:function(e){if(e.getParameter("name")==="Liste"){this.registerNavFrom(this);var s=this.getView().getModel("i18n").getResourceBundle().getText("listeTitle");this.getView().byId("title").setText(s+" "+t.aList.DeliveryDocument);this.getView().byId("breadcrumbs").setCurrentLocationText(s+" "+t.aList.DeliveryDocument);this._resetModel();this._initStepInputs()}},backToHome:function(){this.getRouter().navTo("Home")},onPressNavBack:function(){this._resetModel();this.activeLine="";this.getView().byId("enregister").setEnabled(false);this.getRouter().navTo("ListeServir")},_resetModel:function(){var e=this;var s=com.eramet.Convergence_Achat_Magasin.Component.getMetadata().getManifestEntry("sap.app").dataSources["API_OUTBOUND_DELIVERY_SRV"].uri;var a=new sap.ui.model.odata.ODataModel(s,true);this.getView().byId("listList").setBusy(true);a.read("/A_OutbDeliveryItem",{success:function(s,a){var i=[];for(var r=0;r<=s.results.length-1;r++){s.results[r].quantity=0;if(s.results[r].DeliveryDocument===t.aList.DeliveryDocument&&s.results[r].PickingStatus!="C"&&Number(s.results[r].ActualDeliveredQtyInBaseUnit)!=0){s.results[r].addEnabled=false;s.results[r].removeEnabled=false;i.push(s.results[r])}}e._CheckMaterialQuantity(i);e.getView().byId("listList").setBusy(false)},error:function(e,t){console.log("fail",t)}});this._setItemHeaderData()},_CheckMaterialQuantity:function(e){var t=this;var s=com.eramet.Convergence_Achat_Magasin.Component.getMetadata().getManifestEntry("sap.app").dataSources["ZI_INV_ARTICLEDETAIL_CDS"].uri;var a=new sap.ui.model.odata.ODataModel(s,true);a.read("/ZI_INV_ARTICLEDETAIL",{success:function(s,a){for(var i=0;i<=e.length-1;i++){for(var r=0;r<=s.results.length-1;r++){if(e[i].Material==s.results[r].matnr){e[i].MaterialDesc=s.results[r].maktg;e[i].MaterialCode=s.results[r].matnr;e[i].Emplacement=s.results[r].lgpbe;e[i].Magasin=s.results[r].lgort;break}else{e[i].MaterialDesc=""}}}t.listModel(e)},error:function(e,t){console.log("fail",t)}})},bPartialPicking:false,_onCheckPartialPicking:function(){var e=this.getView();var t=e.getModel("listModel").getData();for(var s=0;s<=t.length-1;s++){if(Number(t[s].quantity)===Number(t[s].ActualDeliveryQuantity)&&Number(t[s].ActualDeliveryQuantity)!=0){this.bPartialPicking=false}else{this.bPartialPicking=true}}},onPressEnregister:function(){var t=this;var s="";var i=this.getView().getModel("i18n").getResourceBundle().getText("detailsDocMessageBoxTitle"),r=this.getView().getModel("i18n").getResourceBundle().getText("detailsDocMessageBoxButton1"),n=this.getView().getModel("i18n").getResourceBundle().getText("detailsDocMessageBoxButton2");this._onCheckPartialPicking();console.log(this.bPartialPicking);if(!this.bPartialInventory){s=this.getView().getModel("i18n").getResourceBundle().getText("listeMessageTextPartial")}else{s=this.getView().getModel("i18n").getResourceBundle().getText("listeMessageText")}a.confirm(s,{title:i,actions:[r,n],onClose:function(s){if(s==="Oui"){e.prototype.displayPopup("L’inventaire a été sauvegardé","Confirmer","warning",function e(){t.onPickItems()})}}})},onPickItems:function(){var e=this;var t=com.eramet.Convergence_Achat_Magasin.Component.getMetadata().getManifestEntry("sap.app").dataSources["API_OUTBOUND_DELIVERY_SRV"].uri;var s=new sap.ui.model.odata.ODataModel(t,true);var i=new sap.ui.model.odata.ODataModel(t,true);var r=this.getView().getModel("listModel").getData();console.log("ListData",r);this.getView().byId("listList").setBusy(true);s.read("A_OutbDeliveryHeader(DeliveryDocument='"+r[0].DeliveryDocument+"')",{success:function(t,s){var n=i;var o=[];console.log(r);for(var l=0;l<r.length;l++){var g={ActualDeliveryQuantity:(Number(r[l].ActualDeliveryQuantity)-Number(r[l].quantity)).toString()};o.push(n.createBatchOperation("PickOneItemWithBaseQuantity?DeliveryDocument='"+r[l].DeliveryDocument+"'&DeliveryDocumentItem='"+Number(r[l].DeliveryDocumentItem).toString()+"'&ActualDeliveredQtyInBaseUnit="+Number(r[l].quantity)+"&BaseUnit='"+r[l].BaseUnit+"'","POST","",{sETag:s.headers.etag}))}n.setUseBatch(true);n.addBatchChangeOperations(o);n.submitBatch(function(t){console.log(t.__batchResponses);if(t.__batchResponses[0].response){var s=JSON.parse(t.__batchResponses[0].response.body);var i=s.error.message.value;a.error(i,{styleClass:"sapUiSizeCompact"})}else{e._onSubmitQuantityBatch()}e.getView().byId("listList").setBusy(false)},function(t,s){console.log(s);e.activeLine="";e.getView().byId("listList").setBusy(false)})},error:function(t,s){console.log("fail",s);e.getView().byId("listList").setBusy(false)}})},_onSubmitQuantityBatch:function(){var e=this;var t=com.eramet.Convergence_Achat_Magasin.Component.getMetadata().getManifestEntry("sap.app").dataSources["API_OUTBOUND_DELIVERY_SRV"].uri;var s=new sap.ui.model.odata.ODataModel(t,true);var i=new sap.ui.model.odata.ODataModel(t,true);var r=this.getView().getModel("listModel").getData();console.log("ListData",r);this.getView().byId("listList").setBusy(true);s.read("A_OutbDeliveryHeader(DeliveryDocument='"+r[0].DeliveryDocument+"')",{success:function(t,s){var n=i;var o=[];console.log(r);for(var l=0;l<r.length;l++){var g={ActualDeliveryQuantity:(Number(r[l].ActualDeliveryQuantity)-Number(r[l].quantity)).toString()};o.push(n.createBatchOperation("A_OutbDeliveryItem(DeliveryDocument='"+r[l].DeliveryDocument+"',DeliveryDocumentItem='"+r[l].DeliveryDocumentItem+"')","PATCH",g,{sETag:s.headers.etag}))}n.setUseBatch(true);n.addBatchChangeOperations(o);n.submitBatch(function(t){console.log(t.__batchResponses);if(t.__batchResponses[0].response){var s=JSON.parse(t.__batchResponses[0].response.body);var i=s.error.message.value;a.error(i,{styleClass:"sapUiSizeCompact"})}else{console.log(e.activeLine);e.activeLine="";e.getView().byId("enregister").setEnabled(false);e.getView().byId("listList").setBusy(false);e.onPressNavBack()}e.getView().byId("listList").setBusy(false)},function(t,s){console.log(s);e.activeLine="";e.getView().byId("listList").setBusy(false)})},error:function(t,s){console.log("fail",s);e.getView().byId("listList").setBusy(false)}})},_setItemHeaderData:function(){var e=t.aList;this.getView().byId("demandeur").setValue(t.aList.CreatedByUser);this.getView().byId("service").setValue(t.aList.DeliveryDocumentType);this.getView().byId("date").setValue(new Date(t.aList.PlannedGoodsIssueDate).toLocaleDateString("FR"));console.log(t.aList)},_checkFullList:function(){var e=this.getView().getModel("listModel").getData(),t=false,s=0;for(var a=0;a<e.length;a++){if(parseInt(e[a].quantity)>0){s++}}if(s===e.length){t=true}console.log(t);if(t){this.getView().byId("enregister").setEnabled(true);this.getView().byId("enregister").setType("Emphasized")}else{this.getView().byId("enregister").setEnabled(false);this.getView().byId("enregister").setType("Ghost")}},_initStepInputs:function(){var e=this.getView().byId("listList").getItems();for(var t=0;t<e.length;t++){e[t].getContent()[0].getItems()[4].getItems()[1].setValue("0");if(parseInt(e[t].getContent()[0].getItems()[4].getItems()[1].getValue())===0){e[t].getContent()[0].getItems()[4].getItems()[0].setEnabled(false);e[t].getContent()[0].getItems()[4].getItems()[1].removeStyleClass("customInputTextGreen")}}},onPressDec:function(e){var t=sap.ui.getCore();t.byId(e.getSource().sId).setEnabled(true);t.byId(e.getSource().oParent.oParent.getItems()[4].getItems()[1].sId).removeStyleClass("customInputTextGreen");t.byId(e.getSource().oParent.oParent.getItems()[4].getItems()[2].sId).setEnabled(true);t.byId(e.getSource().oParent.oParent.getItems()[4].getItems()[1].sId).setValue(parseInt(e.getSource().oParent.oParent.getItems()[4].getItems()[1].getValue())-1);var s=e.getSource().sId.split("listList-")[1];this.getView().getModel("listModel").getData()[s].ActualDeliveredQtyInBaseUnit=parseInt(this.getView().getModel("listModel").getData()[s].ActualDeliveredQtyInBaseUnit)+1;this.getView().getModel("listModel").refresh(true);if(parseInt(e.getSource().oParent.oParent.getItems()[4].getItems()[1].getValue())===0){t.byId(e.getSource().sId).setEnabled(false)}this._checkFullList()},onPressInc:function(e){var t=sap.ui.getCore();t.byId(e.getSource().oParent.oParent.getItems()[4].getItems()[1].sId).removeStyleClass("customInputTextGreen");t.byId(e.getSource().oParent.oParent.getItems()[4].getItems()[0].sId).setEnabled(true);t.byId(e.getSource().oParent.oParent.getItems()[4].getItems()[1].sId).setValue(parseInt(e.getSource().oParent.oParent.getItems()[4].getItems()[1].getValue())+1);var s=e.getSource().sId.split("listList-")[1];this.getView().getModel("listModel").getData()[s].ActualDeliveredQtyInBaseUnit=parseInt(this.getView().getModel("listModel").getData()[s].ActualDeliveredQtyInBaseUnit)-1;this.getView().getModel("listModel").refresh(true);if(parseInt(this.getView().getModel("listModel").getData()[s].ActualDeliveredQtyInBaseUnit)===0){t.byId(e.getSource().sId).setEnabled(false);t.byId(e.getSource().oParent.oParent.getItems()[4].getItems()[1].sId).addStyleClass("customInputTextGreen")}this._checkFullList()},onCheckValue:function(e){var t=sap.ui.getCore(),s=parseInt(e.getSource().getValue()),a=e.getSource().sId.split("listList-")[1],i=parseInt(this.aOldValues[a]);if(s<=i){t.byId(e.getSource().sId).removeStyleClass("customInputTextGreen");t.byId(e.getSource().oParent.oParent.getItems()[4].getItems()[1].sId).setValue(s);this.getView().getModel("listModel").getData()[a].ActualDeliveredQtyInBaseUnit=i-s;this.getView().getModel("listModel").refresh(true);if(i===0){t.byId(e.getSource().oParent.oParent.getItems()[4].getItems()[2].sId).setEnabled(false)}if(s===0){t.byId(e.getSource().oParent.oParent.getItems()[4].getItems()[0].sId).setEnabled(false)}if(this.getView().getModel("listModel").getData()[a].ActualDeliveredQtyInBaseUnit===0){t.byId(e.getSource().oParent.oParent.getItems()[4].getItems()[2].sId).setEnabled(false);t.byId(e.getSource().oParent.oParent.getItems()[4].getItems()[0].sId).setEnabled(true);t.byId(e.getSource().sId).addStyleClass("customInputTextGreen")}if(this.getView().getModel("listModel").getData()[a].ActualDeliveredQtyInBaseUnit>0){t.byId(e.getSource().oParent.oParent.getItems()[4].getItems()[2].sId).setEnabled(true)}}else{t.byId(e.getSource().oParent.oParent.getItems()[4].getItems()[1].sId).setValue("");this.getView().getModel("listModel").getData()[a].ActualDeliveredQtyInBaseUnit=this.aOldValues[a];this.getView().getModel("listModel").refresh(true)}this._checkFullList()},activeLine:"",onEnableItem:function(e){var t=e.getSource().sId.split("-")[4];var s=this.getView().getModel("listModel");this._onSetListItemInactive();s.getData()[t].quantity>0?s.getData()[t].removeEnabled=true:"";if(parseInt(s.getData()[t].ActualDeliveryQuantity)!=0){s.getData()[t].addEnabled=true}s.refresh(true);this.activeLine=t},_onSetListItemInactive:function(){var e=this.getView().getModel("listModel");if(this.activeLine===""){}else{e.getData()[this.activeLine].addEnabled=false;e.getData()[this.activeLine].removeEnabled=false}this.getView().getModel("listModel").refresh(true);console.log(this.getView().getModel("listModel").getData())}})});