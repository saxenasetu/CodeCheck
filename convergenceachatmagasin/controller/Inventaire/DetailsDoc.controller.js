sap.ui.define(["com/eramet/Convergence_Achat_Magasin/controller/BaseController","com/eramet/Convergence_Achat_Magasin/util/constans","com/eramet/Convergence_Achat_Magasin/util/formatter","sap/m/MessageBox"],function(e,t,s,a){"use strict";return e.extend("com.eramet.Convergence_Achat_Magasin.controller.Inventaire.DetailsDoc",{onInit:function(){this.getRouter().attachRoutePatternMatched(this._onRouteMatched,this)},_onRouteMatched:function(e){if(e.getParameter("name")==="DetailsDoc"){this.registerNavFrom(this);var s=this.getView().getModel("i18n").getResourceBundle().getText("detailsDoc");this.getView().byId("breadcrumbs").setCurrentLocationText(s+" "+t.aDetailDoc.PhysicalInventoryDocumentTitle);this._resetModel();this._onSetSearchFieldEmpty()}},_setTitle:function(){var e=this.getView().getModel("i18n").getResourceBundle().getText("detailsDoc"),t=this.getView().getModel("documentsModel").getData().length;this.getView().byId("title").setText(e+" "+t)},backToHome:function(){this._resetModel();this.getRouter().navTo("Home");this.activeLine=""},onPressNavBack:function(){this._resetModel();this.getRouter().navTo("Inventaire");this.activeLine=""},_resetModel:function(){var e=[];var s=this;var a=com.eramet.Convergence_Achat_Magasin.Component.getMetadata().getManifestEntry("sap.app").dataSources["MM_IM_PHYS_INV_DOC_SRV"].uri;var n=new sap.ui.model.odata.ODataModel(a,true);n.read("/C_PhysInvtryDocItemObjPage",{success:function(a,n){console.log(t.aDetailDoc.PhysicalInventoryDocumentTitle.split(" ")[0]);console.log(a.results[0].PhysicalInventoryDocument);for(var o=0;o<a.results.length;o++){if(a.results[o].PhysicalInventoryDocument===t.aDetailDoc.PhysicalInventoryDocumentTitle.split(" ")[0]){a.results[o].addEnabled=false;a.results[o].removeEnabled=false;a.results[o].baseQuantity=0;a.results[o].Quantity="0";a.results[o].emplacement=" ";a.results[o].designation="Désignation "+o;e.push(a.results[o])}}s.onConcatModels(e);s.documentsModel(e);s.getView().getModel("documentsModel").setData(e);s.getView().getModel("documentsModel").refresh(true);s._checkFullList();s._setTitle();s._initStepInputs()},error:function(e,t){console.log("fail",t)}})},onConcatModels:function(e){var t=this;var s=com.eramet.Convergence_Achat_Magasin.Component.getMetadata().getManifestEntry("sap.app").dataSources["ZI_INV_ARTICLEDETAIL_CDS"].uri;var a=new sap.ui.model.odata.ODataModel(s,true);var n=[];a.read("ZI_INV_ARTICLEDETAIL",{success:function(s,a){console.log(s.results);for(var n=0;n<s.results.length;n++){for(var o=0;o<e.length;o++){if(e[o].Material==s.results[n].matnr){e[o].materialDesc=s.results[n].maktx;e[o].designation=s.results[n].mtart;t.documentsModel(e)}}}},error:function(e,t){console.log("fail",t)}})},onSuggest:function(e){var t=e.getParameter("suggestValue"),s=[];if(t){s.push(new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.Contains,t),new sap.ui.model.Filter("designation",sap.ui.model.FilterOperator.Contains,t)],and:false}))}this.getView().byId("searchField").getBinding("suggestionItems").filter(s);this.getView().byId("searchField").suggest()},onSearch:function(e){t.aDoc=[];var s=e.getParameter("suggestionItem"),a=this.getView();if(s===undefined){if(a.byId("searchField").mBindingInfos&&a.byId("searchField").mBindingInfos.suggestionItems&&a.byId("searchField").mBindingInfos.suggestionItems.binding&&a.byId("searchField").mBindingInfos.suggestionItems.binding.aIndices&&a.byId("searchField").mBindingInfos.suggestionItems.binding.aIndices.length>0){var n=[],o=this.getModel("documentsModel").getData();for(var i=0;i<a.byId("searchField").mBindingInfos.suggestionItems.binding.aIndices.length;i++){n.push(o[a.byId("searchField").mBindingInfos.suggestionItems.binding.aIndices[i]])}t.aDoc=n;this.documentsModel(n)}}else{var n=[];a.byId("searchField").setValue(e.mParameters.suggestionItem.mProperties["description"].split(" ")[0]);var r=this.getModel("documentsModel").getData();for(var i=0;i<r.length;i++){if(r[i]["Material"]===e.mParameters.suggestionItem.mProperties["description"].split(" - ")[0]){n.push(r[i])}}this.documentsModel(n)}this.activeLine=""},_onSetSearchFieldEmpty:function(){this.getView().byId("searchField").setValue("")},onChangeQuantity:function(e){console.log(e);var t=this.getView().getModel("documentsModel").getData(),s=e.getSource().sId.split("documentList-")[1];t[s].quantity=e.getSource().getValue();this.getView().getModel("documentsModel").updateBindings(true);this.getView().getModel("documentsModel").refresh(true);this._checkFullList();this._initStepInputs()},_checkFullList:function(){var e=this.getView().getModel("documentsModel").getData(),t=false,s=0;for(var a=0;a<e.length;a++){if(parseInt(e[a].quantity)>0){s++}}if(s>=1){t=true}if(t){this.getView().byId("confirmer").setEnabled(true);this.getView().byId("confirmer").setType("Emphasized")}else{this.getView().byId("confirmer").setEnabled(false);this.getView().byId("confirmer").setType("Ghost")}if(s===e.length){this.bPartialInventory=false}else{this.bPartialInventory=true}},onPressConfirmer:function(){var t=this;var s="";var n=this.getView().getModel("i18n").getResourceBundle().getText("detailsDocMessageBoxTitle"),o=this.getView().getModel("i18n").getResourceBundle().getText("detailsDocMessageBoxButton1"),i=this.getView().getModel("i18n").getResourceBundle().getText("detailsDocMessageBoxButton2");console.log(this.bPartialInventory);if(this.bPartialInventory){s=this.getView().getModel("i18n").getResourceBundle().getText("detailsDocPartialMessageText")}else{s=this.getView().getModel("i18n").getResourceBundle().getText("detailsDocMessageText")}a.confirm(s,{title:n,actions:[o,i],onClose:function(s){console.log(s);if(s==="Oui"){e.prototype.displayPopup("L’inventaire a été sauvegardé","Confirmer","warning",function e(){t.onCountItems()})}}})},onCountItems:function(){var e=this;var t=com.eramet.Convergence_Achat_Magasin.Component.getMetadata().getManifestEntry("sap.app").dataSources["API_PHYSICAL_INVENTORY_DOC_SRV"].uri;var s=new sap.ui.model.odata.ODataModel(t,true);var n=new sap.ui.model.odata.ODataModel(t,true);var o=this.getView().getModel("documentsModel").getData();s.read("A_PhysInventoryDocHeader(PhysicalInventoryDocument='"+o[0].PhysicalInventoryDocument+"',FiscalYear='"+o[0].FiscalYear+"')",{success:function(t,s){var i=n;var r=[];var l;for(var g=0;g<o.length;g++){if(o[g].Quantity>0){l={QuantityInUnitOfEntry:""+o[g].Quantity+"",UnitOfEntry:""+o[g].UnitOfEntry+"",Material:""+o[g].Material+"",Batch:o[g].Batch};r.push(i.createBatchOperation("A_PhysInventoryDocItem(PhysicalInventoryDocument='"+o[g].PhysicalInventoryDocument+"',FiscalYear='"+o[g].FiscalYear+"',PhysicalInventoryDocumentItem='"+o[g].PhysicalInventoryDocumentItem+"')","PATCH",l,{sETag:s.headers.etag}))}}i.setUseBatch(true);i.addBatchChangeOperations(r);i.submitBatch(function(t){console.log(t.__batchResponses);if(t.__batchResponses[0].response){var s=JSON.parse(t.__batchResponses[0].response.body);var n=s.error.message.value;a.error(n,{styleClass:"sapUiSizeCompact"})}else{e.onPressNavBack()}},function(e,t){})},error:function(e,t){console.log("fail",t)}})},onOpenAjoutDePosteDialog:function(e){var t=sap.ui.xmlfragment("com.eramet.Convergence_Achat_Magasin.view.fragment.ajoutDePoste",this);this.getView().addDependent(t);t.open();this._fillAjoutDePosteDialog()},_fillAjoutDePosteDialog:function(){var e=this.getView().getModel("documentsModel").getData(),t=sap.ui.getCore(),s="Code article "+(e.length+1),a="Désignation "+(e.length+1),n="Emplacement "+(e.length+1);t.byId("codeArt").setValue(s);t.byId("designation").setValue(a);t.byId("emplacement").setValue(n)},onPressClose:function(){var e=this.getView().getModel("documentsModel").getData(),t=sap.ui.getCore(),s={};s.title=t.byId("codeArt").getValue();s.designation=t.byId("designation").getValue();s.emplacement=t.byId("emplacement").getValue();t.byId("quantity").getValue()===""?s.Quantity=0:s.Quantity=t.byId("quantity").getValue();s.addEnabled=true;s.removeEnabled=false;e.push(s);this.documentsModel(e);this._onSetListItemInactive();this.activeLine=this.getView().getModel("documentsModel").getData().length-1;this._checkFullList();this._initStepInputs();this._setTitle();this._closePopup()},_closePopup:function(){var e=sap.ui.getCore();e.byId("ajoutDePoste").close();e.byId("ajoutDePoste").destroy()},onPressSave:function(){var t=this;var s=this.getView().getModel("documentsModel").getData();e.prototype.displayPopup("L’inventaire n°"+t.getView().byId("breadcrumbs").getProperty("currentLocationText")+" a été réalisé","Sauvetage","success",function e(){var t=this;var s=com.eramet.Convergence_Achat_Magasin.Component.getMetadata().getManifestEntry("sap.app").dataSources["API_PHYSICAL_INVENTORY_DOC_SRV"].uri;var a=new sap.ui.model.odata.ODataModel(s,true);var n=new sap.ui.model.odata.ODataModel(s,true)});this.documentsModel(s);this._initStepInputs();this._setTitle()},_initStepInputs:function(){var e=this.getView().byId("documentList").getItems();console.log(this.getView().byId("documentList").getItems());for(var t=0;t<e.length;t++){if(parseInt(e[t].getContent()[0].getItems()[3].getItems()[1].getValue())===0){e[t].getContent()[0].getItems()[3].getItems()[0].setEnabled(false)}}},onPressDec:function(e){var t=sap.ui.getCore(),s=parseInt(t.byId(e.getSource().oParent.oParent.getItems()[3].getItems()[1].sId).getValue());s=s-1;t.byId(e.getSource().oParent.oParent.getItems()[3].getItems()[1].sId).setValue(""+s);var a=e.getSource().sId.split("documentList-")[1];this.getView().getModel("documentsModel").getData()[a].quantity=s;this.getView().getModel("documentsModel").refresh(true);this._checkFullList();if(parseInt(t.byId(e.getSource().oParent.oParent.getItems()[3].getItems()[1].sId).getValue())===0){t.byId(e.getSource().oParent.oParent.getItems()[3].getItems()[0].sId).setEnabled(false)}else{t.byId(e.getSource().oParent.oParent.getItems()[3].getItems()[0].sId).setEnabled(true)}},onPressInc:function(e){var t=sap.ui.getCore();var s=parseInt(t.byId(e.getSource().oParent.oParent.getItems()[3].getItems()[1].sId).getValue());s=s+1;t.byId(e.getSource().oParent.oParent.getItems()[3].getItems()[1].sId).setValue(""+s);var a=e.getSource().sId.split("documentList-")[1];this.getView().getModel("documentsModel").getData()[a].quantity=s;this.getView().getModel("documentsModel").refresh(true);this._checkFullList();if(parseInt(t.byId(e.getSource().oParent.oParent.getItems()[3].getItems()[1].sId).getValue())>0){t.byId(e.getSource().oParent.oParent.getItems()[3].getItems()[0].sId).setEnabled(true)}else{t.byId(e.getSource().oParent.oParent.getItems()[3].getItems()[0].sId).setEnabled(false)}},activeLine:"",bPartialInventory:false,onEnableItem:function(e){var t=e.getSource().sId.split("-")[4];var s=this.getView().getModel("documentsModel");this._onSetListItemInactive();s.getData()[t].quantity>0?s.getData()[t].removeEnabled=true:"";s.getData()[t].addEnabled=true;s.refresh(true);this.activeLine=t},_onSetListItemInactive:function(){var e=this.getView().getModel("documentsModel");if(this.activeLine===""){}else{e.getData()[this.activeLine].addEnabled=false;e.getData()[this.activeLine].removeEnabled=false}this.getView().getModel("documentsModel").refresh(true);console.log(this.getView().getModel("documentsModel").getData())}})});