sap.ui.define(["com/eramet/maintenanceF5D/controller/BaseController","com/eramet/maintenanceF5D/util/util","com/eramet/maintenanceF5D/util/formatter","sap/m/MessageBox","sap/m/upload/Uploader","sap/m/StandardListItem","sap/ui/core/Item","sap/m/library","sap/ui/model/json/JSONModel"],function(e,t,a,i,o,n,s,r,l){"use strict";return e.extend("com.eramet.maintenanceF5D.controller.OT.ToOpDetail",{onInit:function(){this.getRouter().attachRoutePatternMatched(this._onRouteMatched,this)},_onRouteMatched:function(e){if(e.getParameter("name")==="ToOpDetail"){var a=this.getView().getModel("i18n").getResourceBundle().getText("toOpDetailTitle");this.getView().byId("finalText").setText(t.oSelectedOT);this.getView().byId("finalText").setTooltip(t.oSelectedOT);this.treeModel(t.sOperationName);if(t.sOperationName&&t.sOperationName.OperationNumber){this._fillWorkCenterModel();this.getView().byId("subOperations").setText(t.sOperationName.OperationNumber);if(t.sOperationName.OperationNumber===this.getView().getModel("i18n").getResourceBundle().getText("toOpDetailNewOperation")){t.sTitleText=this.getView().getModel("i18n").getResourceBundle().getText("toOpDetailNewOperation");this.setTitle();this._setDisplayModel("C");this.getView().byId("breadcrumbs").setCurrentLocationText(this.getView().getModel("i18n").getResourceBundle().getText("toOpDetailNewOperation"))}else{t.sTitleText=a+" "+t.sOperationName.OperationNumber;this.setTitle();this._setDisplayModel("R");this.getView().byId("breadcrumbs").setCurrentLocationText(a+" "+t.sOperationName.OperationNumber)}}this._resetContent()}},_resetModel:function(e){var t=com.eramet.maintenanceF5D.Component.getMetadata().getManifestEntry("sap.app").dataSources["ZUI5_GW_PM_NOTIF_SRV"].uri,a=new sap.ui.model.odata.ODataModel(t,true),o=this;a.read("NotificationHeaderSet('"+e+"')?$expand=Items",null,null,false,function(e){if(e&&e.Items&&e.Items.results.length&&e.Items.results.length>0){o.opDetailModel(e.Items.results[0])}},function(e){var t=""+JSON.stringify(e.responseText.split('"message"')[1].split('"value"')[1].split('"innererror"')[0]);t=t.split(":")[1].split("},")[0];var a=t.substring(2,t.length-2);i.error(a,{styleClass:"sapUiSizeCompact"})})},_fillWorkCenterModel:function(){var e=com.eramet.maintenanceF5D.Component.getMetadata().getManifestEntry("sap.app").dataSources["API_WORK_CENTERS"].uri,t=new sap.ui.model.odata.ODataModel(e,true),a=this;t.read("A_WorkCenters",null,null,false,function(e){if(e&&e.results&&e.results.length&&e.results.length>0){console.log("oData:",e);var t={key:"",text:""};e.results.unshift(t);a.workCenterModel(e.results)}},function(e){var t=""+JSON.stringify(e.responseText.split('"message"')[1].split('"value"')[1].split('"innererror"')[0]);t=t.split(":")[1].split("},")[0];var a=t.substring(2,t.length-2);i.error(a,{styleClass:"sapUiSizeCompact"})})},onHandleSuggest:function(e){var t=this.getView().byId("workCenter").getValue();var a=this;this.getView().byId("workCenter").setFilterFunction(function(e,t){return t.getText().match(new RegExp(e,"i"))});var i,o,n,s;var r="WorkCenter";i="$filter=substringof('"+t.toUpperCase()+"',"+r+")";o="A_WorkCenters/";n=com.eramet.maintenanceF5D.Component.getMetadata().getManifestEntry("sap.app").dataSources["API_WORK_CENTERS"].uri;s=new sap.ui.core.ListItem({text:"{path: 'workCenterModel>WorkCenter'}",key:"{path: 'workCenterModel>WorkCenter'}"});var l=new sap.ui.model.odata.ODataModel(n,true);l.read(o,null,[i],true,function(e){a.getView().getModel("workCenterModel").setData(e.results);a.getView().byId("workCenter").bindAggregation("suggestionItems",{path:"workCenterModel>/",width:"200px",template:s})})},onDeleteKey:function(e){var t=this.getView();if(e.mParameters.id){t.byId("clientIdKey").setValue("")}},onSuggSelected:function(e){var t=this.getView(),a=t.getModel("workCenterModel").getData();if(a.length>0){for(var i=0;i<a.length;i++){if(e.getParameters().selectedItem.mProperties.key==a[i].WorkCenter){t.byId("workCenter").setSelectedKey(a[i].WorkCenter);t.byId("workCenter").setValue(a[i].WorkCenter)}}}},_setDisplayModel:function(e){var a={},i=[];a.mode=e;if(e==="R"){a.icon="sap-icon://edit";a.editable=false;a.editable2=false;a.StartDate=t.sOperationName.StartDate;a.EndDate=t.sOperationName.EndDate;this.getView().byId("workCenter").setValue(t.sOperationName.WorkCenter);this._resetModel(t.oSelectedOTFull.NotificationNumber)}else if(e==="R"&&this.getView().byId("workCenter").getenabled()===true){a.icon="sap-icon://save";a.editable=true;a.editable2=false;a.StartDate=t.sOperationName.StartDate;a.EndDate=t.sOperationName.EndDate;this.getView().byId("workCenter").setValue(t.sOperationName.WorkCenter);this._resetModel(t.oSelectedOTFull.NotificationNumber)}else{a.icon="sap-icon://save";a.editable=true;a.editable2=true;a.StartDate=null;a.EndDate=null;this.getView().byId("workCenter").setValue("");this.opDetailModel([]);this._fillWorkCenterModel()}i.push(a);this.opViewModel(a)},onPressEdit:function(){var e=this.getView().getModel("opViewModel").getData().editable,a=e===true?"sap-icon://edit":"sap-icon://save",i={editable:!e,editable2:false,icon:a,StartDate:this.getView().byId("startDate").getDateValue(),EndDate:this.getView().byId("endDate").getDateValue()};if(a==="sap-icon://edit"){if(t.sOperationName.OperationNumber===this.getView().getModel("i18n").getResourceBundle().getText("toOpDetailNewOperation")){console.log("should be create!");this._createOperation()}else{this.onPressSave()}}this.opViewModel(i)},backToHome:function(){this._resetContent();this.getRouter().navTo("Home")},backToFollowup:function(){this._resetContent();this.getRouter().navTo("Followup")},onPressOTDetail:function(){this._resetContent();this.getRouter().navTo("OTDetail")},backToOperations:function(){this._resetContent();this.getRouter().navTo("Operations")},onPressNavBack:function(){this._resetContent();this.getRouter().navTo("Operations")},onPressNavToOTDetail:function(){this.getRouter().navTo("OTDetail")},onPressAdd:function(e){sap.ui.getCore().byId(e.getSource().sId).setVisible(false);var t=this,a=this.getView().byId("list"),i=new sap.ui.layout.form.SimpleForm({columnsL:1,columnsM:1,editable:true,emptySpanL:4,emptySpanM:4,labelSpanL:3,labelSpanM:3,layout:"ResponsiveGridLayout",maxContainerCols:2}),o=new sap.m.CustomListItem({}),n=new sap.m.Label({text:this.getView().getModel("i18n").getResourceBundle().getText("toOpDetailDate1")}),s=new sap.m.DateTimePicker({}),r=new sap.m.Label({text:this.getView().getModel("i18n").getResourceBundle().getText("toOpDetailDate2")}),l=new sap.m.DateTimePicker({}),d=new sap.m.Label({text:this.getView().getModel("i18n").getResourceBundle().getText("toOpDetailIntervenant")}),u=new sap.m.Input({});i.addContent(n);i.addContent(s);i.addContent(r);i.addContent(l);i.addContent(d);i.addContent(u);o.addContent(i);var p=new sap.m.Bar({contentRight:[new sap.m.Button({icon:"sap-icon://sys-minus",press:function(e){t.onPressRemove(e)}}),new sap.m.Button({icon:"sap-icon://sys-add",press:function(e){t.onPressAdd(e)}})]});o.addContent(p);a.addItem(o)},onPressRemove:function(e){var t=this.getView().byId("list");if(t.getItems().length!==1){if(e.getSource().oParent.oParent.sId===t.getItems()[t.getItems().length-1].sId){sap.ui.getCore().byId(t.getItems()[t.getItems().length-2].getContent()[1].getContentRight()[1].sId).setVisible(true)}t.removeItem(e.getSource().oParent.oParent.sId)}},_resetContent:function(){var e=this.getView().byId("additionalBox").getContent().length;if(e>6){for(var t=e-1;t>6;t--){this.getView().byId("additionalBox").removeContent(t)}}},onPressSave:function(){var e=this.getView().getModel("i18n").getResourceBundle().getText("toOpDetailConfirmText"),a=this.getView().getModel("i18n").getResourceBundle().getText("toOpDetailTitleText"),o=this.getView().getModel("i18n").getResourceBundle().getText("toOpDetailFermer"),n=this.getView().getModel("i18n").getResourceBundle().getText("toOpDetailSave"),s=this;i.confirm(e,{title:a,actions:[n,o],onClose:function(e){if(e===n){console.log("util.sOperationName!!!!",t.sOperationName);s._updateOT()}}})},_updateOT:function(){var e=com.eramet.maintenanceF5D.Component.getMetadata().getManifestEntry("sap.app").dataSources["ZUI5_GW_PM_ORDER_SRV"].uri,a=new sap.ui.model.odata.v2.ODataModel(e),o=this,n={OrderNumber:t.sOperationName.OrderNumber,SubOperation:t.sOperationName.SubOperation,OperationNumber:t.sOperationName.OperationNumber,WorkCenter:this.getView().byId("workCenter").getValue()},s={WorkCenter:this.getView().byId("workCenter").getValue()};a.update("/OrderOperationSet(OrderNumber='"+n.OrderNumber+"',SubOperation='',OperationNumber='"+t.sOperationName.OperationNumber+"')",s,{method:"PUT",success:function(e){var t=o;i.success("Successfully updated the OT",{styleClass:"sapUiSizeCompact",actions:["OK"],onClose:function(e){if(e==="OK"){t.backToFollowup()}}})}.bind(this),error:function(e){console.log(e);var t=""+JSON.stringify(e.responseText.split('"message"')[1].split('"value"')[1].split('"innererror"')[0]);t=t.split(":")[1].split("},")[0];var a=t.substring(2,t.length-2);i.error(a,{styleClass:"sapUiSizeCompact"})}})},_createOperation:function(){var e=com.eramet.maintenanceF5D.Component.getMetadata().getManifestEntry("sap.app").dataSources["ZUI5_GW_PM_ORDER_SRV"].uri,t=new sap.ui.model.odata.v2.ODataModel(e,true),a={OrderNumber:this.getView().byId("finalText").getText(),WorkCenter:this.getView().byId("workCenter").getValue()};t.create("/OrderOperationSet",a,{success:function(e){var t=that;i.success("Successfully created the operation",{styleClass:"sapUiSizeCompact",actions:["OK"],onClose:function(e){if(e==="OK"){t.backToFollowup()}}})},error:function(e){console.log(e);var t=""+JSON.stringify(e.responseText.split('"message"')[1].split('"value"')[1].split('"innererror"')[0]);t=t.split(":")[1].split("},")[0];var a=t.substring(2,t.length-2);i.error(a,{styleClass:"sapUiSizeCompact"})}})},onPressArticle:function(){this.getRouter().navTo("Article")},onPressCamera:function(){function e(e){alert("success")}function t(e){alert("fail"+e)}navigator.camera.getPicture(e,t,{quality:50,destinationType:Camera.DestinationType.DATA_URL})},onPressFileBrowser:function(){var e=sap.ui.xmlfragment("com.eramet.maintenanceF5D.view.fragment.fileUpload",this);this.getView().addDependent(e);e.open();var t=sap.ui.require.toUrl("com/eramet/maintenanceF5D/model")+"/items.json",a=sap.ui.getCore().byId("UploadSet");this.getView().setModel(new l(t));a.getList().setMode(r.ListMode.MultiSelect);a.getDefaultFileUploader().setButtonOnly(false);a.getDefaultFileUploader().setIcon("sap-icon://attachment")},onItemAdded:function(e){var t=[],a=sap.ui.getCore(),i={fileName:e.getParameters().item.mProperties.fileName,mediaType:e.getParameters().item.mProperties.mediaType,uploadState:e.getParameters().item.mProperties.uploadState};t.push(i);for(var o=0;o<a.byId("UploadSet").mBindingInfos.items.binding.oList.length;o++){t.push(a.byId("UploadSet").mBindingInfos.items.binding.oList[o])}this.uploadedModel(t)},onUploadComplete:function(e){var t=sap.ui.getCore().byId("UploadSet"),a=t.getModel().getData();a.items.unshift({documentId:jQuery.now().toString(),fileName:e.getParameter("files")[0].fileName,mimeType:"",thumbnailUrl:"",url:"",attributes:[{title:"Uploaded By",text:"You",active:false},{title:"Uploaded On",text:new Date(jQuery.now()).toLocaleDateString(),active:false},{title:"File Size",text:"505000",active:false}],statuses:[{title:"",text:"",state:"None"}],markers:[{}],selected:false});this.getView().getModel("uploadedModel").refresh();setTimeout(function(){MessageToast.show("UploadComplete event triggered.")},4e3)},onUploadSelectedButton:function(){var e=sap.ui.getCore().byId("UploadSet");e.upload(e._oList.getItems())},onDownloadSelectedButton:function(){var e=sap.ui.getCore().byId("UploadSet");e.getItems().forEach(function(e){if(e.getListItem().getSelected()){e.download(true)}})},onPressClose:function(){var e=sap.ui.getCore();e.byId("uploadDialog").close();e.byId("uploadDialog").destroy()}})});