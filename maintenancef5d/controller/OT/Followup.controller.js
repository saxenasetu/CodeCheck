sap.ui.define(["com/eramet/maintenanceF5D/controller/BaseController","com/eramet/maintenanceF5D/util/util","com/eramet/maintenanceF5D/util/formatter","sap/m/MessageBox"],function(e,t,i,s){"use strict";return e.extend("com.eramet.maintenanceF5D.controller.OT.Followup",{bIsDFirstVisit:true,bIsTFirstVisit:true,aGlobalFilters:[],onInit:function(){this.getRouter().attachRoutePatternMatched(this._onRouteMatched,this)},_onRouteMatched:function(e){if(e.getParameter("name")==="Followup"){this.registerNavFrom(this);this._resetModel();var i=this.getView().getModel("i18n").getResourceBundle().getText("followupTitle");t.sTitleText=i;this.setTitle();this.getView().byId("type").setSelectedKey("");this.getView().byId("type").setEnabled(true);if(this.getView().getModel("followupListModel")&&this.getView().getModel("followupListModel").getData()&&this.getView().getModel("followupListModel").getData().length>0){if(t.sCustomer==="R"){this._setFilters(false,false,true,0,4);this.getView().byId("type").setSelectedKey("ZM03");this.getView().byId("type").setEnabled(false);this.onSelectItem()}else if(t.sCustomer==="D"){if(this.bIsDFirstVisit){this.bIsDFirstVisit=false;this._deleteFilters();this.getView().byId("type").setSelectedKey("ZM02");this.onSelectItem()}else{this.onSelectItem()}}else{if(this.bIsTFirstVisit){this.bIsTFirstVisit=false;this._deleteFilters()}}if(t.otFilters&&t.otFilters[0]){this.getView().byId("filter").setType("Accept")}else{t.otFilters=[];this.getView().byId("filter").setType("Default")}}}},_setFilters:function(e,i,s,o,n){var a={prio1:e,prio2:i,prio3:s,range1:o,range2:n};t.otFilters=[a]},_deleteFilters:function(){t.otFilters=[]},_filterList:function(e){var i=[];if(e){i.push(e);this.getView().byId("type").setSelectedKey(e.oValue1);this.getView().byId("followupList").getBinding("items").filter(new sap.ui.model.Filter(i,true))}var s=this;this.getView().byId("followupList").setBusy(true);if(t.otFilters&&t.otFilters[0]){var o=t.otFilters[0],n=[],a=o.prio1?"1":"",r=o.prio2?"2":"",l=o.prio3?"3":"",d=new Date,u=null;if((new Date).getMonth()-o.range1+1<=0){u=new Date((new Date).getFullYear()-1+"/"+((new Date).getMonth()-o.range1+13)+"/"+"01").getTime()}else{u=new Date((new Date).getFullYear()+"/"+((new Date).getMonth()-o.range1+1)+"/"+"01").getTime()}var g=null;if((new Date).getMonth()-o.range2+1<=0){g=new Date((new Date).getFullYear()-1+"/"+((new Date).getMonth()-o.range2+13)+"/"+"01").getTime()}else{g=new Date((new Date).getFullYear()+"/"+((new Date).getMonth()-o.range2+1)+"/"+"01").getTime()}if(u>g){var p=u;u=g;g=p}var f=[];if(a==="1"||r==="2"||l==="3"){if(a==="1"){f.push(new sap.ui.model.Filter("Priority",sap.ui.model.FilterOperator.Contains,a))}if(r==="2"){f.push(new sap.ui.model.Filter("Priority",sap.ui.model.FilterOperator.Contains,r))}if(l==="3"){f.push(new sap.ui.model.Filter("Priority",sap.ui.model.FilterOperator.Contains,l))}i.push(new sap.ui.model.Filter(f,false));if(t.otFilters[0].range1&&t.otFilters[0].range2){i.push(new sap.ui.model.Filter("StartDate",sap.ui.model.FilterOperator.BT,u,g));this.aGlobalFilters=i}}else{if(t.otFilters[0].range1&&t.otFilters[0].range2){i.push(new sap.ui.model.Filter("StartDate",sap.ui.model.FilterOperator.BT,u,g));this.aGlobalFilters=i}this.aGlobalFilters=i}this.getView().byId("followupList").getBinding("items").filter(new sap.ui.model.Filter(i,true));if(e){this.getView().byId("type").setSelectedKey(e.oValue1)}}this.getView().byId("followupList").setBusy(false)},backToHome:function(){this._resetDatas();this.getRouter().navTo("Home")},onPressNavBack:function(){this._resetDatas();this.getRouter().navTo("WorkPage")},onPressNavToFilter:function(){this._resetDatas();this.getRouter().navTo("Filter")},onPressNavToOTDetail:function(e){this._resetDatas();var i=e.getParameter("listItem")||e.getSource();var s=e.getSource().oBindingContexts.followupListModel.sPath.split("/")[1],o=this.getModel("followupListModel").getData();t.oSelectedOT=i.getTitle().split(" ")[2];t.oSelectedOTFull=o[s];this.getRouter().navTo("Operations")},onPressRefresh:function(){this.getView().byId("followupList").setBusy(true);this._resetModel();this.getView().byId("followupList").setBusy(false)},_resetModel:function(){var e=com.eramet.maintenanceF5D.Component.getMetadata().getManifestEntry("sap.app").dataSources["ZUI5_GW_PM_ORDER_SRV"].uri,i=new sap.ui.model.odata.ODataModel(e,true),o=this;this.getView().byId("followupList").setBusy(true);i.read("OrderHeaderSet?$expand=HeaderToOperations/OperationComponent,HeaderToOperations/MeausurementPoint",null,null,false,function(e){console.log("oData of OT:",e);if(e&&e.results&&e.results.length&&e.results.length>0){t.aOTElements=e.results;o.followupListModel(e.results);o.getView().byId("followupList").setBusy(false);o._filterList()}else{alert("Empty OrderHeaderSet odata!");o.getView().byId("followupList").setBusy(false)}}.bind(this),function(e){var t=""+JSON.stringify(e.responseText.split('"message"')[1].split('"value"')[1].split('"innererror"')[0]);t=t.split(":")[1].split("},")[0];var i=t.substring(2,t.length-2);o.getView().byId("followupList").setBusy(false);s.error(i,{styleClass:"sapUiSizeCompact"})}.bind(this))},onOpenOTSearchDialog:function(e){var t=sap.ui.xmlfragment("com.eramet.maintenanceF5D.view.fragment.searchOT",this);this.getView().addDependent(t);this._resetModel();t.open()},onPressAccept:function(){var e=sap.ui.getCore(),i=e.byId("searchField").getSuggestionItems()[0]?e.byId("searchField").getSuggestionItems()[0].getText():"",s={};if(t.aFilteredOT.length>0){this.followupListModel(t.aFilteredOT)}else{for(var o=0;o<this.getModel("followupListModel").getData().length;o++){if(i===this.getModel("followupListModel").getData()[o].OrderId){s=this.getModel("followupListModel").getData()[o];break}}this.followupListModel([s])}this.onPressClose()},onPressClose:function(){var e=sap.ui.getCore();e.byId("searchOTDialog").close();e.byId("searchOTDialog").destroy()},onSuggest:function(e){var t=e.getParameter("suggestValue"),i=[],s=sap.ui.getCore();if(t){i=[new sap.ui.model.Filter([new sap.ui.model.Filter("OrderId",function(e){return(e||"").toUpperCase().indexOf(t.toUpperCase())>-1}),new sap.ui.model.Filter("OrderType",function(e){return(e||"").toUpperCase().indexOf(t.toUpperCase())>-1}),new sap.ui.model.Filter("FunctionalLocation",function(e){return(e||"").toUpperCase().indexOf(t.toUpperCase())>-1}),new sap.ui.model.Filter("Priority",function(e){return(e||"").toUpperCase().indexOf(t.toUpperCase())>-1}),new sap.ui.model.Filter("SystemStatus",function(e){return(e||"").toUpperCase().indexOf(t.toUpperCase())>-1}),new sap.ui.model.Filter("ShortText",function(e){return(e||"").toUpperCase().indexOf(t.toUpperCase())>-1}),new sap.ui.model.Filter("NotificationNumber",function(e){return(e||"").toUpperCase().indexOf(t.toUpperCase())>-1})],false)]}s.byId("searchField").getBinding("suggestionItems").filter(i);s.byId("searchField").suggest()},onSearch:function(e){var i=sap.ui.getCore();t.aFilteredOT=[];var s=e.getParameter("suggestionItem");if(s===undefined){if(i.byId("searchField").mBindingInfos&&i.byId("searchField").mBindingInfos.suggestionItems&&i.byId("searchField").mBindingInfos.suggestionItems.binding&&i.byId("searchField").mBindingInfos.suggestionItems.binding.aIndices&&i.byId("searchField").mBindingInfos.suggestionItems.binding.aIndices.length>0){var o=[],n=this.getModel("followupListModel").getData();for(var a=0;a<i.byId("searchField").mBindingInfos.suggestionItems.binding.aIndices.length;a++){o.push(n[i.byId("searchField").mBindingInfos.suggestionItems.binding.aIndices[a]])}t.aFilteredOT=o}}},_resetDatas:function(){this._resetIcons()},_resetIcons:function(){this.getView().byId("date").setIcon("");this.getView().byId("prio").setIcon("");this.getView().byId("statut").setIcon("")},onPressDate:function(){var e="";if(this.getView().byId("date").getIcon!==""){if(this.getView().byId("date").getIcon()==="sap-icon://up"){this.getView().byId("date").setIcon("sap-icon://down");e=true}else{this.getView().byId("date").setIcon("sap-icon://up");e=false}}else{this.getView().byId("date").setIcon("sap-icon://up");e=false}this.getView().byId("prio").setIcon("");this.getView().byId("statut").setIcon("");this.getView().byId("followupList").getBinding("items").sort(new sap.ui.model.Sorter("StartDate",e,false))},onSelectItem:function(e){var t=this.getView().byId("type").getSelectedItem()?this.getView().byId("type").getSelectedKey():"",i=new sap.ui.model.Filter("OrderType",sap.ui.model.FilterOperator.Contains,t);if(t==="00"){i=new sap.ui.model.Filter("OrderType",sap.ui.model.FilterOperator.Contains,"")}this._filterList(i)},onPressPrio:function(){var e="";if(this.getView().byId("prio").getIcon!==""){if(this.getView().byId("prio").getIcon()==="sap-icon://up"){this.getView().byId("prio").setIcon("sap-icon://down");e=true}else{this.getView().byId("prio").setIcon("sap-icon://up");e=false}}else{this.getView().byId("prio").setIcon("sap-icon://up");e=false}this.getView().byId("date").setIcon("");this.getView().byId("statut").setIcon("");this.getView().byId("followupList").getBinding("items").sort(new sap.ui.model.Sorter("Priority",e,false))},onPressStaut:function(){var e="";if(this.getView().byId("statut").getIcon!==""){if(this.getView().byId("statut").getIcon()==="sap-icon://up"){this.getView().byId("statut").setIcon("sap-icon://down");e=true}else{this.getView().byId("statut").setIcon("sap-icon://up");e=false}}else{this.getView().byId("statut").setIcon("sap-icon://up");e=false}this.getView().byId("date").setIcon("");this.getView().byId("prio").setIcon("");this.getView().byId("followupList").getBinding("items").sort(new sap.ui.model.Sorter("SystemStatus",e,false))}})});